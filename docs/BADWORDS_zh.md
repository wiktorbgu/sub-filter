[EN](FILTER_RULES_en.md) / [RU](FILTER_RULES_ru.md) / [ZH](FILTER_RULES_zh.md)

此翻译由神经网络完成，如有任何错误，敬请谅解。

- [`badwords.yaml` 文档](#badwordsyaml-文档)
- [目的和概念](#目的和概念)
  - [什么是"坏词"?](#什么是坏词)
  - [两种过滤策略](#两种过滤策略)
- [文件结构](#文件结构)
  - [规则字段](#规则字段)
  - [最小示例](#最小示例)
- [动作类型](#动作类型)
  - [动作: `strip`](#动作-strip)
  - [动作: `delete`](#动作-delete)
- [正则表达式语法](#正则表达式语法)
  - [基本构造](#基本构造)
  - [特殊序列](#特殊序列)
  - [修饰符](#修饰符)
  - [转义特殊字符](#转义特殊字符)
- [实际例子](#实际例子)
  - [例 1: 移除版本号](#例-1-移除版本号)
  - [例 2: 移除质量/状态标记](#例-2-移除质量状态标记)
  - [例 3: 阻止私有 IP（解析错误指示器）](#例-3-阻止私有-ip解析错误指示器)
  - [例 4: 阻止垃圾邮件和恶意软件](#例-4-阻止垃圾邮件和恶意软件)
  - [例 5: 阻止无效端口](#例-5-阻止无效端口)
- [模式编写规则](#模式编写规则)
  - [✅ 最佳实践](#-最佳实践)
  - [⚠️ 常见错误](#️-常见错误)
- [调试和测试](#调试和测试)
  - [YAML 语法验证](#yaml-语法验证)
  - [模式测试](#模式测试)
  - [故障排除](#故障排除)
- [组织建议](#组织建议)
  - [规则顺序](#规则顺序)
  - [YAML 注释](#yaml-注释)
- [结论](#结论)

---

## `badwords.yaml` 文档

## 目的和概念

`badwords.yaml` 文件是 `sub-filter` 程序中**过滤和修改代理链接名称的规则集**。

把它看作一个**"坏词"字典**，但不是审查意义上的——而是**从服务器名称中删除垃圾、垃圾邮件或危险信息**。

### 什么是"坏词"?

**"坏词"**是在代理名称中出现且不希望出现在最终列表中的模式（单词、短语或正则表达式）。例子：

- **[TEST]** 在名称中 → 表示测试服务器（生产列表中不需要）
- **[SPAM]** 在名称中 → 明显的垃圾邮件标记
- **192.168.x.x** 在名称中 → 私有 IP（解析错误的迹象）
- **v1.2.3** 在名称中 → 版本号（使名称变得混乱）

### 两种过滤策略

`sub-filter` 在找到模式时支持**两种处理策略**：

1. **`strip`** — 仅从名称中移除找到的模式，**保留服务器**（服务器已接受，名称已清理）
2. **`delete`** — 移除**整个行**（服务器完全被拒绝）

**策略的选择**取决于**被过滤内容的重要性**：

- `strip` — 用于**轻微垃圾**（版本、标记、演示版本）
- `delete` — 用于**严重错误**（垃圾邮件、恶意软件、无效参数、本地 IP）

---

## 文件结构

`badwords.yaml` 文件包含一个**规则数组**。每个规则都是一个有两个字段的对象：

```yaml
- pattern: "您的正则表达式"
  action: "strip"

- pattern: "另一个表达式"
  action: "delete"
```

### 规则字段

| 字段      | 类型   | 必需 | 描述                           |
| --------- | ------ | ---- | ------------------------------ |
| `pattern` | 字符串 | ✅ 是 | 正则表达式（Go `regexp` 语法） |
| `action`  | 字符串 | ✅ 是 | `"strip"` 或 `"delete"`        |

### 最小示例

```yaml
# 从名称中删除单词 "test"
- pattern: "test"
  action: "strip"

# 如果名称包含 "spam"，拒绝整个服务器
- pattern: "\\[spam\\]"
  action: "delete"
```

---

## 动作类型

### 动作: `strip`

**行为**：匹配的子字符串从名称中**删除**，服务器**保留在列表中**。

**过程**：
1. 在服务器名称中查找与模式匹配的内容
2. 删除找到的匹配项
3. 将多个空格合并为一个
4. 删除开头和结尾的空格
5. **返回更新的名称**

**何时使用**：
- 删除版本（`v1.2.3`）
- 删除测试标记（`[TEST]`、`[DEMO]`）
- 删除不影响功能的垃圾（`#1`、`@admin` 等）

**示例结果**：
```
输入名称:    "My [TEST] Server v1.2.3"
模式 1:      "\[TEST\]" (strip)  →  "My  Server v1.2.3"
模式 2:      "v\d+\.\d+\.\d+" (strip)  →  "My Server"
最终名称:    "My Server"
状态:        ✅ 已接受
```

### 动作: `delete`

**行为**：匹配的子字符串**拒绝整个行**，服务器从列表中**完全排除**。

**过程**：
1. 在服务器名称中查找与模式匹配的内容
2. 如果找到匹配项：**拒绝服务器**
3. 如果没有匹配项：继续处理

**何时使用**：
- 阻止危险内容（`[SPAM]`、`[MALWARE]`）
- 阻止私有 IP（解析错误的迹象）
- 阻止无效端口（`port: 99999`）
- 阻止已弃用的协议

**示例结果**：
```
输入名称:    "Server [SPAM] in US"
模式:        "\\[spam\\]" (delete, 不区分大小写)
结果:        ❌ 已拒绝（整行已删除）
```

---

## 正则表达式语法

`sub-filter` 使用 **Go `regexp` 包**（POSIX 扩展正则表达式语法和 Go 扩展）。

### 基本构造

| 构造     | 含义                   | 例子                         |
| -------- | ---------------------- | ---------------------------- |
| `.`      | 任何字符（除 `\n` 外） | `a.c` → `abc`、`aXc`         |
| `*`      | 0 个或更多             | `ab*c` → `ac`、`abc`、`abbc` |
| `+`      | 1 个或更多             | `ab+c` → `abc`、`abbc`       |
| `?`      | 0 个或 1 个            | `ab?c` → `ac`、`abc`         |
| `[abc]`  | 字符之一               | `[aeiou]` → 任何元音         |
| `[^abc]` | 不是字符之一           | `[^0-9]` → 非数字            |
| `[a-z]`  | 范围                   | `[0-9]` → 任何数字           |
| `(...)`  | 分组                   | `(ab)+` → `ab`、`abab`       |
| `\|`     | 或                     | `cat\|dog` → `cat` 或 `dog`  |

### 特殊序列

| 序列 | 含义                         |
| ---- | ---------------------------- |
| `\d` | 任何数字（0-9）              |
| `\D` | 非数字                       |
| `\w` | 字母、数字、下划线           |
| `\W` | 非字母、数字、下划线         |
| `\s` | 空格（空格、制表符、换行符） |
| `\S` | 非空格字符                   |
| `^`  | 行首                         |
| `$`  | 行尾                         |
| `\b` | 单词边界                     |
| `\\` | 转义特殊字符                 |

### 修饰符

**Go `regexp` 使用内置语法标志**：

| 标志   | 目的                             |
| ------ | -------------------------------- |
| `(?i)` | 不区分大小写搜索（放在模式开头） |
| `(?m)` | 多行模式                         |

**例子**：
```
(?i)test              # "test"、"TEST"、"Test" — 全部匹配
(?i)\[demo\]          # "[DEMO]"、"[demo]"、"[Demo]" — 全部匹配
```

### 转义特殊字符

如果需要搜索**字面意思的特殊字符**（而不是其特殊含义），用反斜杠转义：

| 字符 | 转义 | 例子                                          |
| ---- | ---- | --------------------------------------------- |
| `.`  | `\.` | `example\.com` → 匹配 "example.com"（带点）   |
| `[`  | `\[` | `\[TEST\]` → 匹配 "[TEST]"（括号）            |
| `(`  | `\(` | `\(v1\)` → 匹配 "(v1)"                        |
| `*`  | `\*` | `\*plus\*` → 匹配 "*plus*"                    |
| `\`  | `\\` | `C:\\path\\to\\file` → 匹配 "C:\path\to\file" |

**⚠️ 在 YAML 中重要**：YAML 本身使用反斜杠进行转义，所以**双倍反斜杠**：

```yaml
# 错误（YAML 会消耗一个反斜杠）：
pattern: "\[TEST\]"  # YAML 读取这个作为 "[TEST" — 不是您想要的！

# 正确：
pattern: "\\[TEST\\]"  # YAML 读取 "\[TEST\]" → regex 理解 "[TEST]"
```

---

## 实际例子

### 例 1: 移除版本号

**任务**：从 "Server v1.2.3 Fast" 中移除版本号，保留服务器。

```yaml
- pattern: '\bv\d+\.\d+(\.\d+)?\b'
  action: "strip"
  # 说明：
  # \b — 单词边界（避免匹配 "version"）
  # v\d+\.\d+ — "v" + 数字 + "." + 数字（v1.2）
  # (\.\d+)? — 可选 ".3"
```

**结果**：
```
输入名称:   "Server v1.2.3 Fast"
Strip 后:   "Server Fast"
状态:       ✅ 已接受，名称已修改
```

### 例 2: 移除质量/状态标记

**任务**：从名称中移除标记如 `[DEMO]`、`(demo)`、`<demo>` —— 不区分大小写。

```yaml
- pattern: '(?i)\[demo\]|\(demo\)|<demo>'
  action: "strip"
  # 说明：
  # (?i) — 不区分大小写搜索（在开头）
  # \[demo\] — "[demo]"（括号转义）
  # | — 或
  # \(demo\) — "(demo)"
  # <demo> — "<demo>"
```

**结果**：
```
"Server [DEMO] US"     →  "Server US"
"My Proxy (demo)"      →  "My Proxy"
"Test <demo> Japan"    →  "Test Japan"
```

### 例 3: 阻止私有 IP（解析错误指示器）

**任务**：如果名称包含私有 IP（不正确解析的迹象），拒绝整个行。

```yaml
- pattern: '(?i)(localhost|127\.0\.0\.1|192\.168\.\d+\.\d+|10\.\d+\.\d+\.\d+|172\.(1[6-9]|2[0-9]|3[01])\.\d+\.\d+)'
  action: "delete"
  # 说明：
  # localhost — 特殊名称
  # 127\.0\.0\.1 — localhost IP（点转义）
  # 192\.168\.\d+\.\d+ — 网络 192.168.0.0/16
  # 10\.\d+\.\d+\.\d+ — 网络 10.0.0.0/8
  # 172\.(1[6-9]|2[0-9]|3[01])\.\d+\.\d+ — 网络 172.16.0.0/12
```

**结果**：
```
"Proxy 192.168.1.1"    →  ❌ 已拒绝
"Server 10.0.0.5"      →  ❌ 已拒绝
"Good Server US"       →  ✅ 已接受
```

### 例 4: 阻止垃圾邮件和恶意软件

**任务**：如果服务器名称包含垃圾邮件、欺诈或恶意软件标记，拒绝该服务器。

```yaml
- pattern: '(?i)\[(spam|fraud|malware|phishing|scam)\]'
  action: "delete"
  # 说明：
  # (?i) — 不区分大小写
  # \[ — 左括号（转义）
  # (spam|fraud|malware|phishing|scam) — 这些单词中的任何一个
  # \] — 右括号
```

**结果**：
```
"Server [SPAM] EU"     →  ❌ 已拒绝
"Good [fraud] Proxy"   →  ❌ 已拒绝
"Normal Server"        →  ✅ 已接受
```

### 例 5: 阻止无效端口

**任务**：如果名称包含范围外的端口（1-65535），拒绝服务器。

```yaml
- pattern: ':(0|6553[6-9]|655[4-9][0-9]|65[6-9][0-9]{2}|6[6-9][0-9]{3}|[7-9][0-9]{4})'
  action: "delete"
  # 说明：
  # : — 冒号（分隔地址和端口）
  # (0|...) — 要么 0，要么 > 65535 的数字
```

**结果**：
```
"Server:99999"         →  ❌ 已拒绝
"Server:0"             →  ❌ 已拒绝
"Server:443"           →  ✅ 已接受
```

---

## 模式编写规则

### ✅ 最佳实践

1. **对整个单词使用单词边界 `\b`**：
   ```yaml
   # 好 — 匹配 "test" 但不匹配 "testing"
   pattern: '\btest\b'
   action: "strip"
   
   # 差 — 匹配 "test"、"testing" 和 "atesting"
   pattern: 'test'
   action: "strip"
   ```

2. **在 YAML 中转义特殊字符（双倍反斜杠）**：
   ```yaml
   # 正确
   pattern: '\\[TEST\\]'
   
   # 错误
   pattern: '\[TEST\]'  # YAML 会消耗反斜杠！
   ```

3. **对不区分大小写的搜索使用 `(?i)`**：
   ```yaml
   # 好 — 匹配 "TEST"、"test"、"Test"
   pattern: '(?i)\[demo\]'
   
   # 差 — 仅匹配 "[demo]"
   pattern: '\[demo\]'
   ```

4. **将替代项分组在括号中**：
   ```yaml
   # 好
   pattern: '(?i)(spam|fraud|malware)'
   
   # 差（可能有歧义）
   pattern: 'spam|fraud|malware'
   ```

5. **对 delete 规则严格，对 strip 规则谨慎**：
   ```yaml
   # 好 — 仅匹配标准版本字符串
   - pattern: '\bv\d+\.\d+\.\d+\b'
     action: "strip"
   
   # 差 — 可能意外删除重要内容
   - pattern: '\d+'
     action: "delete"
   ```

### ⚠️ 常见错误

| 错误                         | 例子                               | 修复                               |
| ---------------------------- | ---------------------------------- | ---------------------------------- |
| 括号未转义                   | `pattern: '[TEST]'`                | `pattern: '\\[TEST\\]'`            |
| 缺少 `(?i)` 用于不区分大小写 | `pattern: '\[demo\]'`              | `pattern: '(?i)\\[demo\\]'`        |
| 模式过于宽泛                 | `pattern: 'a'`                     | `pattern: '(?i)\\[a\\]'`（更具体） |
| YAML 中无转义                | `pattern: "\[TEST\]"`              | `pattern: "\\[TEST\\]"`（双斜杠）  |
| 单词边界位置错误             | `pattern: 'test\b'` 用于 "testing" | `pattern: '\btest\b'`（两侧）      |

---

## 调试和测试

### YAML 语法验证

确保您的 `badwords.yaml` 文件在语法上正确：

```bash
# 尝试加载配置（程序将显示解析错误）
./sub-filter

# 如果配置加载无 YAML 错误，它将输出：
# "Configuration loaded successfully"
```

### 模式测试

**方法 1：在线正则表达式测试器**

访问 [regex101.com](https://regex101.com)：
1. 从"Flavor"菜单中选择**"Go"**
2. 在"Regular Expression"字段中粘贴您的模式
3. 在"Test String"字段中粘贴测试名称
4. 检查匹配

**例子**：
```
Flavor:        Go
Pattern:       (?i)\[demo\]|\(demo\)|<demo>
Test strings:  
  My [DEMO] Server    ✅ 匹配
  Test (demo) US      ✅ 匹配
  Server <demo>       ✅ 匹配
  Normal Server       ❌ 不匹配
```

**方法 2：本地测试（Go）**

创建文件 `test_pattern.go`：
```go
package main

import (
	"fmt"
	"regexp"
)

func main() {
	pattern := `(?i)\[demo\]|\(demo\)|<demo>`
	re := regexp.MustCompile(pattern)
	
	testCases := []struct {
		name  string
		input string
		want  bool
	}{
		{"[DEMO]", "My [DEMO] Server", true},
		{"(demo)", "Test (demo) US", true},
		{"<demo>", "Server <demo>", true},
		{"normal", "Normal Server", false},
	}
	
	for _, tc := range testCases {
		result := re.MatchString(tc.input)
		status := "✅"
		if result != tc.want {
			status = "❌"
		}
		fmt.Printf("%s %s: %v (expected %v)\n", status, tc.name, result, tc.want)
	}
}
```

运行它：
```bash
go run test_pattern.go
```

### 故障排除

| 问题                                | 原因                   | 解决方案                                        |
| ----------------------------------- | ---------------------- | ----------------------------------------------- |
| 启动时出现 "Error: invalid pattern" | 正则表达式语法错误     | 用 Go 标志在 regex101.com 上检查模式            |
| 模式与预期字符串不匹配              | 缺少 `(?i)` 或转义错误 | 对不区分大小写使用 `(?i)`；检查 YAML 中的双斜杠 |
| Strip 删除太多                      | 模式过于宽泛           | 缩小范围（添加 `\b` 或更具体的字符）            |
| Delete 拒绝好的服务器               | 模式意外匹配           | 使模式更具体（例如 `\[SPAM\]` 而不是 `SPAM`）   |

---

## 组织建议

### 规则顺序

建议按逻辑**组织规则**：

1. **首先是 Strip 规则**（清理）
   - 版本
   - 测试标记
   - 演示标记

2. **其次是 Delete 规则**（拒绝关键问题）
   - 垃圾邮件/恶意软件
   - 私有 IP
   - 无效端口

```yaml
# 好的组织
# === Strip 规则（清理）===
- pattern: '\bv\d+\.\d+(\.\d+)?\b'
  action: "strip"

- pattern: '(?i)\[test(ing|ed|er)?\]'
  action: "strip"

# === Delete 规则（阻止）===
- pattern: '(?i)\[(spam|fraud|malware)\]'
  action: "delete"

- pattern: '192\.168\.\d+\.\d+'
  action: "delete"
```

### YAML 注释

使用 YAML 注释进行文档记录：

```yaml
# 删除版本字符串（v1.2.3、v2.0）
- pattern: '\bv\d+\.\d+(\.\d+)?\b'
  action: "strip"

# 阻止标记为垃圾邮件的服务器
- pattern: '(?i)\[spam\]'
  action: "delete"
```

---

## 结论

`badwords.yaml` 文件是用于**订阅自动清理和过滤**的强大工具。正确的配置使您能够：

- ✅ **保留有用的服务器**（使用 `strip`）
- ✅ **排除被垃圾邮件淹没的来源**（使用 `delete`）
- ✅ **确保最终列表的清洁**（自动删除版本、标记、错误）

**从简单的模式开始**（精确单词和短语），然后**根据需要过渡到更复杂的正则表达式**。

如有疑问 — 使用 **regex101.com** 进行视觉模式测试。
