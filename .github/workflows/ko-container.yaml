name: ghcr.io ko container ci

on:
  workflow_dispatch:
  push:
    tags: ["v*"]

permissions:
  contents: read
  packages: write
  actions: write
  id-token: write

env:
  IMAGE_REGISTRY: ghcr.io
  # IMAGE_NAME intentionally omitted â€” derived from go.mod

jobs:
  build:
    name: Build and Push Multi-Platform Container
    runs-on: ubuntu-latest
    timeout-minutes: 20 # multi-platform takes longer
    outputs:
      image: ${{ steps.build.outputs.image }}
      digest: ${{ steps.build.outputs.digest }}
    steps:
      - name: Normalize repository owner to lowercase
        run: |
          echo "REPO_OWNER_LOWER=$(echo '${{ github.repository_owner }}' | tr '[:upper:]' '[:lower:]')" >> "$GITHUB_ENV"

      - name: Checkout
        uses: actions/checkout@v6

      - name: Determine version and tags
        id: version
        run: |
          REF="${{ github.ref }}"
          if [[ "$REF" == refs/tags/v* ]]; then
            VERSION="${REF#refs/tags/v}"
            MAJOR="${VERSION%%.*}"
            MINOR="${VERSION#*.}"
            MINOR="${MINOR%%.*}"
            TAGS="v${VERSION},latest,${MAJOR}.${MINOR},${MAJOR}"
          else
            VERSION="0.0.0-${GITHUB_SHA::8}"
            TAGS="latest,sha-${GITHUB_SHA::8}"
          fi
          echo "VERSION=${VERSION}" >> "$GITHUB_ENV"
          echo "TAGS=${TAGS}" >> "$GITHUB_OUTPUT"

      - name: Set up Git for reproducibility
        run: git config --global core.autocrlf false

      - name: Set up Go
        uses: actions/setup-go@v6
        with:
          go-version-file: ./go.mod

      - name: Cache Go modules
        uses: actions/cache@v5
        with:
          path: |
            ~/.cache/go-build
            ~/go/pkg/mod
          key: ${{ runner.os }}-go-${{ hashFiles('**/go.sum') }}

      - name: Set up QEMU
        uses: docker/setup-qemu-action@v3

      - name: Set up buildx
        uses: docker/setup-buildx-action@v3

      - name: Create and bootstrap buildx builder
        run: |
          # Create a named builder using the docker-container driver for multi-platform builds
          docker buildx create --name=ko-builder --driver docker-container --use || true
          docker buildx inspect --bootstrap

      - name: Login to GitHub Container Registry
        uses: docker/login-action@v2
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Set up ko
        uses: ko-build/setup-ko@v0.9

      - name: Build and push multi-platform image with ko
        id: build
        run: |
          KO_DOCKER_REPO="${IMAGE_REGISTRY}/${REPO_OWNER_LOWER}"
          IFS=',' read -ra TAG_ARRAY <<< "${{ steps.version.outputs.TAGS }}"
          TAG_ARGS=""
          for tag in "${TAG_ARRAY[@]}"; do
            TAG_ARGS="$TAG_ARGS --tags=$tag"
          done

          # Build for multiple platforms (omit legacy 386 to reduce build size/time).
          # Include arm/v7 and arm/v6 for broad Raspberry Pi compatibility.
          export KO_DOCKER_REPO="${IMAGE_REGISTRY}/${REPO_OWNER_LOWER}"
          ko build \
            -v \
            -B \
            --platform=linux/amd64,linux/arm64,linux/arm/v7,linux/arm/v6 \
            --sbom=spdx-json \
            $TAG_ARGS \
            --image-refs=.digest \
            .

          DIGEST=$(grep -o 'sha256:[a-f0-9]\{64\}' .digest | head -n1)
          echo "digest=${DIGEST}" >> "$GITHUB_OUTPUT"

          IMAGE=$(head -n1 .digest | cut -d'@' -f1 | cut -d':' -f1)
          echo "image=${IMAGE}" >> "$GITHUB_OUTPUT"

      - name: Show built image references
        run: cat .digest

      - name: Inspect built image manifest
        run: |
          IMAGE=${{ steps.build.outputs.image }}
          DIGEST=${{ steps.build.outputs.digest }}
          if [ -n "${IMAGE}" ] && [ -n "${DIGEST}" ]; then
            echo "Inspecting ${IMAGE}@${DIGEST}"
            # Print raw manifest list (platforms, digests). If imagetools is unavailable,
            # this will fail gracefully without breaking the workflow.
            docker buildx imagetools inspect "${IMAGE}@${DIGEST}" --raw || true
          else
            echo "No image/digest to inspect"
          fi

      - name: Install cosign (sigstore action)
        uses: sigstore/cosign-installer@v4.0.0
        with:
          cosign-release: "v3.0.3"

      - name: Keyless sign built image (cosign)
        if: always()
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          # Use keyless signing via OIDC (requires id-token permission)
          IMAGE=${{ steps.build.outputs.image }}
          DIGEST=${{ steps.build.outputs.digest }}
          if [ -n "${IMAGE}" ] && [ -n "${DIGEST}" ]; then
            cosign sign --keyless ${IMAGE}@${DIGEST} || echo "cosign sign failed"
          else
            echo "No image/digest to sign"
          fi

  provenance:
    name: Generate SLSA Provenance
    needs: build
    uses: slsa-framework/slsa-github-generator/.github/workflows/generator_container_slsa3.yml@v1.10.0
    with:
      image: ${{ needs.build.outputs.image }}
      digest: ${{ needs.build.outputs.digest }}
      registry-username: ${{ github.actor }}
      compile-generator: true
    secrets:
      registry-password: ${{ secrets.GITHUB_TOKEN }}
