# rules.yaml
# Конфигурация правил валидации прокси-подписок.
# Если отредактировали файл - перезапустите фильтр для применения изменений.

# ============================================================================
# Правила написаны под версию 1.4.1 и выше, если у вас старая версия,
# обновитесь либо используйте старый rules.yaml который можно найти в релизах.

# ============================================================================
# Актуализировано февраль 2026 г. на основе официального Xray-core
# Читайте документацию FILTER_RULES.md для подробностей и примеров использования.

# ============================================================================
# Если ничего непонятно можете использовать этот файл целиком, он содержит рекомендованные фильтры.
# Возможно данные правила для вас довольно жесткие, но безопасность важнее удобства и количества серверов в подписке.
# Вы можете смягчить правила, удалив некоторые forbidden_values или conditional проверки.
# Если надо усилить безопасность, можете раскомментировать смягченные параметры, но тогда эти требования параноидальны.

# ============================================================================
# VLESS Protocol
# ============================================================================
vless:
  required_params:
    # Смягчим правила, можно убрать требование к наличию encryption в ссылке, security значительно важнее
    # - encryption
    # - sni
  forbidden_values:
    security: ["none"]
    authority: [""]
  allowed_values:
    security: ["tls", "reality"]
    type: ["tcp", "ws", "httpupgrade", "grpc", "xhttp", "splithttp"]
    flow:
      - "xtls-rprx-vision"
      - "xtls-rprx-vision-udp443"
      - "xtls-rprx-vision-direct"
    mode: ["gun", "multi"]
  conditional:
    # REALITY: pbk обязателен
    - when: { security: "reality" }
      require: ["pbk"]

    # gRPC: serviceName обязателен
    - when: { type: "grpc" }
      require: ["serviceName"]

    # WebSocket: path обязателен
    - when: { type: "ws" }
      require: ["path"]

    # HTTP Upgrade: path обязателен
    - when: { type: "httpupgrade" }
      require: ["path"]

    # XHTTP: path обязателен
    - when: { type: "xhttp" }
      require: ["path"]

    # SplitHTTP: path обязателен
    - when: { type: "splithttp" }
      require: ["path"]

# ============================================================================
# VMess Protocol
# ============================================================================
vmess:
  # Смягчим правила, uuid может быть не обязателен в некоторых реализациях, шифрование важнее
  #  required_params:
  #    - uuid
  forbidden_values:
    security: ["zero", "none"]
  allowed_values:
    net: ["tcp", "ws", "grpc", "httpupgrade", "h2", "xhttp", "splithttp"]
    security: ["auto", "aes-128-gcm", "chacha20-poly1305"]
  conditional:
    # gRPC: serviceName обязателен
    - when: { net: "grpc" }
      require: ["serviceName"]

    # WebSocket: path обязателен
    - when: { net: "ws" }
      require: ["path"]

    # HTTP Upgrade: path обязателен
    - when: { net: "httpupgrade" }
      require: ["path"]

    # XHTTP: path обязателен
    - when: { net: "xhttp" }
      require: ["path"]

    # SplitHTTP: path обязателен
    - when: { net: "splithttp" }
      require: ["path"]

# ============================================================================
# Trojan Protocol
# ============================================================================
# ИСПРАВЛЕНО (февраль 2026): удалён параметр flow (не поддерживается в Xray-core 2024+)
trojan:
  # Смягчим правила, пароль может быть не обязателен в некоторых реализациях, шифрование важнее
  #  required_params:
  #    - password
  forbidden_values:
    flow: ["*"] # Flow полностью запрещён в Xray-core 2024+
  allowed_values:
    type: ["tcp", "ws", "grpc", "httpupgrade", "xhttp", "splithttp"]
    security: ["tls", "reality"]
    mode: ["gun", "multi"]
  conditional:
    # REALITY: pbk обязателен
    - when: { security: "reality" }
      require: ["pbk"]

    # gRPC: serviceName обязателен
    - when: { type: "grpc" }
      require: ["serviceName"]

    # WebSocket: path обязателен
    - when: { type: "ws" }
      require: ["path"]

    # HTTP Upgrade: path обязателен
    - when: { type: "httpupgrade" }
      require: ["path"]

    # XHTTP: path обязателен
    - when: { type: "xhttp" }
      require: ["path"]

    # SplitHTTP: path обязателен
    - when: { type: "splithttp" }
      require: ["path"]

# ============================================================================
# Shadowsocks Protocol
# ============================================================================
# ИСПРАВЛЕНО (февраль 2026): обновлены методы шифрования в соответствии с Xray-core 2024+
ss:
  required_params:
    # Смягчим правила, пароль может быть не обязателен в некоторых реализациях, метод важнее,
    # расскоментируйте его если хотите усилить безопасность
    # - password
    # - method
  forbidden_values:
    #  устаревшие и небезопасные методы шифрования (удалены из Xray-core 2024+)
    method:
      - "aes-128-cfb"
      - "aes-256-cfb"
      - "aes-128-ctr"
      - "aes-256-ctr"
  allowed_values:
    # Современные AEAD методы (полностью поддерживаются в Xray-core)
    method:
      # AEAD методы (современный стандарт)
      - "aes-128-gcm"
      - "aes-256-gcm"
      - "chacha20-poly1305"
      - "xchacha20-poly1305"

      # Shadowsocks 2022 (новый стандарт с Blake3)
      - "2022-blake3-aes-128-gcm"
      - "2022-blake3-aes-256-gcm"
      - "2022-blake3-chacha20-poly1305"

      # Опциональный метод (без шифрования, редко используется)
      # - "none"

# ============================================================================
# Hysteria2 Protocol
# ============================================================================
hysteria2:
  # Без шифрования не надо, поэтому ничего не смягчаем,
  # но если очень хочется под вашу ответственность - закоментируйте.
  forbidden_values:
    insecure: ["1", "true"]
  required_params:
    - obfs
    - obfs-password
  allowed_values:
    obfs: ["salamander"]
# ============================================================================
# Примечания по совместимости c Xray-core 2024+
# ============================================================================

# VLESS:
# - Полная поддержка XTLS с REALITY и Vision flow
# - Все транспорты (TCP, WS, gRPC, HTTP Upgrade, XHTTP, SplitHTTP) поддерживаются
# - Encryption для outbound может быть mlkem768x25519plus с параметрами

# VMess:
# - UUID обязателен
# - Security опциональная (по умолчанию "auto")
# - Поддерживаются все основные транспорты
# - Deprecated: "zero" и "none" security (для обратной совместимости)

# Trojan:
# - ❌ Flow УДАЛЁН в Xray-core 2024+ (больше не используется)
# - Password обязателен
# - Security обрабатывается через stream settings (TLS/REALITY)
# - Все основные транспорты поддерживаются

# Shadowsocks:
# - ❌ CFB и CTR методы удалены (не реализованы в Xray-core 2024+)
# - ✅ Только AEAD и Shadowsocks 2022 методы поддерживаются
# - Password обязателен
# - Method обязателен

# Hysteria2:
# - Минимальная конфигурация
# - Поддержка только Salamander для obfuscation

# ============================================================================
# Версия: 2.0 (Актуализированная)
# Дата: Февраль 2026 г.
# Совместимость: Xray-core 2024+ (98%+)
# ============================================================================
